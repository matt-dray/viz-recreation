---
title: "Draft: Recreate Spear with {ggplot2}"
author: "Matt Dray"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Here's a short code walkthrough to get you started with recreating Spear's cotton plot. It shows an approach to generating the linechart using the {ggplot2} package in R.

If you haven't already, install the {tidyverse} package for data manipulation and plotting, and the {extrafont} package for font handling.

```{r eval=FALSE}
install.packages("ggplot2", "tidyr", "extrafont")
```

You can download for free [the Routed Gothic font by Darren Embry](https://webonastick.com/fonts/routed-gothic/), which is a good approximation of the lettering used by Spear. Installation will depend on your operating system. Attach {extrafont} and it will fetch your installed fonts to use in R.

```{r}
library(extrafont)
```

The dataset is quite small, so we can create the dataframe ourselves.

```{r cars}
cotton_raw <- data.frame(
  year           = 1942:1948,
  us_consumption = c(11160, 9993,  9693,  9423,  10072, 9374,  7833),
  exports        = c(1480,  1139,  2007,  3613,  3545,  1968,  4785),
  stocks         = c(10657, 10744, 11164, 7326,  2530,  3080,  5283),
  total_supply   = c(23297, 21876, 22864, 20362, 16147, 14422, 17901)
)
```

It's preferable to make the data 'tidy' so that there's one row per year and consumption type, and one column for each variable. The {tidyr} package can help us pivot the data from 'long' format to this 'wide' format.

```{r}
library(tidyr)

cotton <- cotton_raw %>% 
  pivot_longer(
    c(us_consumption, exports, stocks), 
    names_to = "consumption_type", values_to = "boles"
  )

cotton
```

Let's build the plot step by step so you can see its development. It won't look like Spear's original work to start with, but we'll get there.

First, we can create a basic line chart of the data. Each consumption type gets a different dashed line.

```{r}
library(ggplot2)

p1 <- ggplot() +
  geom_line(
    data = cotton,
    aes(
      x = year, 
      y = boles / 1000,
      linetype = consumption_type
    ),
    size = 1.5
  ) +
  scale_linetype_manual(
    values = c("longdash", "dashed", "solid")
  )

p1
```

With {ggplot2} it's tricky to put tick marks inside the plotting space and to add a secondary x-axis. A simple hack is to add points at the plot margins. Hyphens and pipes make good horizontal and vertical marks.

```{r}
p2 <- p1 +
  geom_point(
    aes(
      x = c(rep(1942, 5), rep(1948, 5)), 
      y = c(rep(seq(2, 10, 2), 2)),
    ),
    shape = "—",
    size = 4
  ) +
  geom_point(
    aes(
      x = 1943:1947,
      y = rep(0, 5)
    ),
    shape = "|",
    size = 4
  ) 

p2
```

Now we must clip the axes: years on the x-axis from 1942 to 1948 and the amount of cotton on the y-axis from 0 to 12. We can also use the `labels` argument to limit the x-axis labels to two digits, like setting 1944 to '44.

```{r}
p3 <- p2 +
  scale_x_continuous(
    breaks = seq(1942, 1948, 1),
    expand = c(0, 0),
    labels = c("1942", paste0("'", 43:48))
  ) +
  scale_y_continuous(
    breaks = seq(0, 12, 2),
    limits = c(0, 12),
    expand = c(0, 0)
  )

p3
```

The line labels can be added with the `annotate()` function. A bit of trial-and-error will help you find where they should be placed. Now is a good time to add the title of the plot as well.

```{r}
p4 <- p3 +
  annotate(
    geom = "text",
    x = c(1946.3, 1945.9, 1943.75),
    y = c(11, 7, 3.2),
    label = c("U. S. Consumption", "Carry–over\nStocks", "Exports"),
    family = "Routed Gothic"
  ) +
  labs(title = "Millions of Boles")

p4
```

The label arrows can be added with `geom_segment()`, with `x` and `y` arguments for the start point and `xend` and `yend` for the end. Again, some manual tinkering of these values will be needed.

```{r}
p5 <- p4 +
  geom_segment(
    aes(
      x = c(1945.2, 1945.3, 1944.2),
      y = c(10.5, 7.4, 3.1),
      xend = c(1945, 1945.1, 1944.4), 
      yend = c(9.7, 7.1, 2.8)
    ),
    arrow = arrow(
      length = unit(2, "mm"),
      type = "closed"
    )
  )

p5
```

We're almost done. The last step is to make a number of minor adjustments to the appearance of the plot using the `theme()` function. We'll set a number of options to remove unneeded features, like the panel background and legend. Then we can add a box around the panel and declare the general font family.

```{r}
p5 + theme(
  panel.background = element_blank(),  # remove background panel
  panel.grid.major = element_blank(),  # remove gridlines
  panel.grid.minor = element_blank(),  # remove gridlines
  axis.ticks = element_blank(),    # remove ticks from both axes
  axis.title.x = element_blank(),  # remove x axis title
  axis.title.y = element_blank(),  # remove y axis title
  axis.line = element_blank(),     # remove all axis lines
  panel.border = element_rect(fill = NA, size = 1),  # 'box' around main panel
  legend.position = "none",        # remove legend
  text = element_text(family = "Routed Gothic")  # set plot font
)
```

Finally we've got a lineplot that looks pretty close to Spear's original. 

Hopefully you've seen that it's easy to create the basic chart, but trickier to make the small adjustments needed to mimic the original author's style.

The next steps are for you to try and create the stacked-barchart panel and then arrange the plots with a main title and surrounding text labels. [The {ggpattern} package](https://coolbutuseless.github.io/package/ggpattern/index.html) may help you recreate the hatchlines on the bars and [{patchwork}](https://patchwork.data-imaginist.com/) could help with the arrangement of the plot and text elements.

[I wrote a blog post](https://www.rostrum.blog/2021/06/08/recreate-spear/) about recreating the whole visualisation using base R functions that may help you.